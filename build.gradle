buildscript {
    ext {
        // Core versions
        springBootVersion = "3.5.0"
        flywayDbVersion = "10.20.1"
        jpackageVersion = "1.7.0"
        sonarqubeVersion = "6.0.1.5171"
        
        // Library versions
        atlantafxVersion = "2.0.1"
        ikonliVersion = "12.3.1"
        bouncycastleVersion = "1.79"
        graalvmVersion = "24.1.1"
        jnaVersion = "5.15.0"
        jsoupVersion = "1.18.3"
        apacheCommonsLangVersion = "3.17.0"
        apacheCommonsCollectionsVersion = "4.4"
        jacksonVersion = "2.18.2"
        
        // Test versions
        junitVersion = "5.11.4"
        archunitVersion = "1.3.0"
        testfxVersion = "4.0.18"
    }
}

plugins {
    id 'org.springframework.boot' version "$springBootVersion" apply false
    id 'org.flywaydb.flyway' version "$flywayDbVersion" apply false
    id 'org.panteleyev.jpackageplugin' version "$jpackageVersion" apply false
    id 'org.sonarqube' version "$sonarqubeVersion"
}

wrapper {
    gradleVersion = "9.2.0"
}

// Project versioning - use environment variable or default
def getVersionName = System.getenv('APP_VERSION') ?: '0.1.0-SNAPSHOT'

subprojects {
    group = 'io.toflowai'
    version = "${getVersionName}"

    apply plugin: 'java'
    apply plugin: 'jacoco'

    java {
        toolchain {
            languageVersion = JavaLanguageVersion.of(25)
        }
    }

    compileJava {
        options.encoding = 'UTF-8'
        options.compilerArgs += [
            '--enable-preview',
            '-Xlint:preview'
        ]
    }

    compileTestJava {
        options.encoding = 'UTF-8'
        options.compilerArgs += ['--enable-preview']
    }

    test {
        jvmArgs '--enable-preview'
    }

    repositories {
        mavenCentral()
    }

    tasks.withType(JavaCompile).configureEach {
        options.compilerArgs << '-parameters'
    }
}

// =============================================================================
// SonarQube Configuration
// =============================================================================
// Usage:
//   ./gradlew sonar -Dsonar.host.url=http://localhost:9000 -Dsonar.token=YOUR_TOKEN
//
// For local analysis without server (SonarLint compatible):
//   ./gradlew sonar -Dsonar.host.url=http://localhost:9000
// =============================================================================
sonar {
    properties {
        property "sonar.projectKey", "ToFlowAI"
        property "sonar.projectName", "ToFlowAI"
        property "sonar.projectVersion", project.version
        property "sonar.organization", "toflowai"
        
        // Source configuration
        property "sonar.sources", "src/main/java"
        property "sonar.tests", "src/test/java"
        property "sonar.java.source", "25"
        property "sonar.sourceEncoding", "UTF-8"
        
        // Coverage reports (JaCoCo)
        property "sonar.coverage.jacoco.xmlReportPaths", 
            "${project.rootDir}/app/build/reports/jacoco/test/jacocoTestReport.xml," +
            "${project.rootDir}/ui/build/reports/jacoco/test/jacocoTestReport.xml," +
            "${project.rootDir}/common/build/reports/jacoco/test/jacocoTestReport.xml"
        
        // Exclusions
        property "sonar.exclusions", [
            "**/generated/**",
            "**/build/**",
            "**/*.css",
            "**/*.fxml"
        ].join(",")
        
        property "sonar.test.exclusions", [
            "**/test/**"
        ].join(",")
        
        // Quality profile settings
        property "sonar.java.checkstyle.reportPaths", "build/reports/checkstyle/main.xml"
        property "sonar.java.pmd.reportPaths", "build/reports/pmd/main.xml"
        property "sonar.java.spotbugs.reportPaths", "build/reports/spotbugs/main.xml"
    }
}

// Ensure test and coverage reports are generated before sonar analysis
tasks.named('sonar').configure {
    dependsOn tasks.named('check')
}
